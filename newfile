# DMINE AWS Data Lake - S3 Bucket Structure & Encryption Strategy

## Document Overview

This document details the S3 bucket architecture, folder structure, and encryption implementation for the DMINE Phase 1 AWS Data Lake, ensuring secure data handling from on-premises sources to curated analytics-ready datasets.

**Document Version**: 2.0  
**Last Updated**: August 2024  
**Classification**: Internal - BMO Confidential

-----

## 1. Executive Summary

The DMINE AWS Data Lake implements a multi-bucket architecture with comprehensive encryption strategy to ensure data security throughout the data lifecycle. The solution employs PGP encryption for on-premises data transfer (where data is unreadable until decrypted), followed by ALE (Application-Level Encryption) using dual KMS for privacy-sensitive data in staging and standard zones.

**Key Security Features:**

- **PGP encryption** for on-premises to cloud data transfer (data unreadable in landing bucket)
- **Lambda-based decryption** to move data from landing to staging with ALE encryption
- **ALE (Application-Level Encryption)** using dual KMS for privacy high-risk data
- **AWS KMS** for key management and encryption services
- **Mutual TLS** for data in transit
- **Comprehensive key management** via AWS Secrets Manager and KMS

**Key Principle**: Data encrypted with PGP in landing bucket is NOT readable by applications (Athena, Glue) until decrypted and moved to staging bucket with ALE encryption.

-----

## 2. S3 Bucket Architecture

### 2.1 Landing Zone - Three Buckets/Folders

#### **Bucket 1: Landing (Incoming - PGP Encrypted)**

```
Bucket Name: s3://bmo-dmine-landing-prod-ca-central/
Region: ca-central-1 (Canada Central)
```

**Purpose**: Initial data arrival point from on-premises sources  
**Encryption**: PGP encrypted - **Data NOT readable by applications**  
**Retention**: 1 week to 1 month (configurable)  
**Data State**: Encrypted files awaiting decryption  
**Access**: Only Lambda decryption function can process files

#### **Bucket 2: Staging (Decrypted - ALE Encrypted)**

```
Bucket Name: s3://bmo-dmine-staging-prod-ca-central/
Region: ca-central-1 (Canada Central)
```

**Purpose**: Validated, decrypted data ready for processing  
**Encryption**: ALE (Application-Level Encryption) using dual KMS for privacy high-risk data  
**Retention**: 30-90 days  
**Data State**: Decrypted from PGP, re-encrypted with ALE, **readable by applications**  
**Access**: Athena, Glue, analytical tools can read data

#### **Bucket 3: Archive (Backup - PGP Encrypted)**

```
Bucket Name: s3://bmo-dmine-archive-prod-ca-central/
Region: ca-central-1 (Canada Central)
```

**Purpose**: Long-term backup for reprocessing capability  
**Encryption**: PGP encrypted (same as landing)  
**Retention**: 1 week to 1 month  
**Data State**: Original PGP encrypted files  
**Use Case**: Emergency reprocessing, disaster recovery

-----

### 2.2 Standard Zone - Curated Data

#### **Standard Bucket (Silver Layer)**

```
Bucket Name: s3://bmo-dmine-standard-prod-ca-central/
Region: ca-central-1 (Canada Central)
```

**Purpose**: Curated, analytics-ready, business-aligned datasets  
**Encryption**: ALE (dual KMS) for privacy high-risk data, standard KMS for others  
**Retention**: Long-term (7+ years for regulatory compliance)  
**Data State**: Transformed, enriched, domain-organized  
**Access**: Full analytical capabilities (Athena, Glue, BI tools)

-----

## 3. Landing Zone Detailed Structure

### 3.1 Landing Bucket - PGP Encrypted (NOT Readable)

```
s3://bmo-dmine-landing-prod-ca-central/
├── batch/
│   ├── source=idp/
│   │   ├── dataset=customer_profiles/
│   │   │   └── year=2024/month=08/day=26/
│   │   │       └── idp_customer_profiles_20240826_001.parquet.gpg
│   │   ├── dataset=transaction_history/
│   │   └── dataset=risk_scores/
│   │
│   ├── source=tsys/
│   │   └── dataset=card_transactions/
│   │       └── year=2024/month=08/day=26/
│   │           └── tsys_card_transactions_20240826_001.csv.gpg
│   │
│   ├── source=servicenow/
│   │   ├── dataset=incidents/
│   │   └── dataset=case_records/
│   │
│   ├── source=sailpoint/
│   │   ├── dataset=user_identities/
│   │   └── dataset=access_logs/
│   │
│   ├── source=mech/
│   ├── source=xim/
│   ├── source=ere/
│   ├── source=pega/
│   └── source=sybaseiq/
│
└── _control/
    ├── manifests/
    └── processing_status/
```

**Encryption State:**

- **Method**: PGP (Pretty Good Privacy) asymmetric encryption
- **File Extension**: `.gpg` or `.pgp`
- **Readability**: **UNREADABLE** by Athena, Glue, or any AWS applications
- **Purpose**: Secure transfer from on-premises to cloud
- **Applies To**: ALL on-premises data sources where required

**Key Management:**

- **Public Key**: Stored in AWS Secrets Manager
- **Private Key**: Stored in AWS Secrets Manager (for Lambda decryption)
- **Original Private Key**: Retained by FileX team on-premises

-----

### 3.2 Staging Bucket - ALE Encrypted (Readable)

```
s3://bmo-dmine-staging-prod-ca-central/
├── batch/
│   ├── source=idp/
│   │   ├── dataset=customer_profiles/  [Privacy High Risk - ALE]
│   │   │   └── year=2024/month=08/day=26/
│   │   │       └── idp_customer_profiles_20240826_staging.parquet
│   │   ├── dataset=transaction_history/  [Privacy High Risk - ALE]
│   │   └── dataset=risk_scores/  [Standard KMS]
│   │
│   ├── source=servicenow/
│   │   ├── dataset=incidents/  [Standard KMS]
│   │   └── dataset=case_records/  [Privacy High Risk - ALE]
│   │
│   ├── source=sailpoint/
│   │   ├── dataset=user_identities/  [Privacy High Risk - ALE]
│   │   └── dataset=access_logs/  [Standard KMS]
│   │
│   └── source=tsys/
│       └── dataset=card_transactions/  [Privacy High Risk - ALE]
│
└── _quality/
    ├── validation_reports/
    └── data_profiling/
```

**Encryption State:**

- **Privacy High-Risk Data**: ALE (Application-Level Encryption) using dual KMS
- **Standard Data**: Single KMS encryption
- **Readability**: **FULLY READABLE** by Athena, Glue, analytical applications
- **Format**: Standardized Parquet files
- **State**: Decrypted from PGP, validated, quality-checked

**ALE Encryption Applied To:**

- Customer profiles with PII
- Transaction data with payment details
- User identity information
- Case records with sensitive investigation data
- Any data classified as “Privacy High Risk”

-----

### 3.3 Archive Bucket - PGP Encrypted (Backup)

```
s3://bmo-dmine-archive-prod-ca-central/
├── batch/
│   ├── source=idp/
│   │   └── dataset=customer_profiles/
│   │       └── year=2024/month=08/
│   │           └── archived_idp_profiles_202408.parquet.gpg
│   │
│   ├── source=tsys/
│   ├── source=servicenow/
│   └── source=sailpoint/
│
└── _metadata/
    └── archive_manifests/
```

**Encryption State:**

- **Method**: PGP encrypted (same as landing)
- **Purpose**: Backup for emergency reprocessing
- **Retention**: 1 week to 1 month
- **Use Case**: If staging data corrupted, can decrypt from archive
- **Readability**: **UNREADABLE** - requires decryption for reprocessing

-----

## 4. Standard Zone Structure

### 4.1 Standard Bucket - Domain-Based with Selective ALE

```
s3://bmo-dmine-standard-prod-ca-central/
│
├── fraud_detection/
│   ├── transaction_alerts/  [Privacy High Risk - ALE]
│   │   ├── batch/
│   │   │   └── year=2024/month=08/day=26/
│   │   │       └── fraud_transaction_alerts_20240826_standard.parquet
│   │   └── streaming/
│   │
│   ├── fraud_scores/  [Privacy High Risk - ALE]
│   └── risk_assessments/  [Standard KMS]
│
├── case_management/
│   ├── investigations/  [Privacy High Risk - ALE]
│   ├── servicenow_incidents/  [Standard KMS]
│   └── evidence_tracking/  [Privacy High Risk - ALE]
│
├── customer_analytics/
│   ├── customer_profiles_360/  [Privacy High Risk - ALE]
│   ├── behavior_patterns/  [Privacy High Risk - ALE]
│   └── risk_segmentation/  [Standard KMS]
│
├── identity_access/
│   ├── sailpoint_identities/  [Privacy High Risk - ALE]
│   ├── access_entitlements/  [Privacy High Risk - ALE]
│   └── access_logs/  [Standard KMS]
│
└── compliance/
    ├── audit_trails/  [Standard KMS]
    ├── regulatory_reports/  [Privacy High Risk - ALE]
    └── data_lineage/  [Standard KMS]
```

**Encryption Decision Logic:**

- **Privacy High Risk**: Apply ALE (dual KMS)
- **Standard/Low Risk**: Apply single KMS encryption
- **Classification driven**: Based on data classification policies

-----

## 5. Encryption Methods Explained

### 5.1 PGP Encryption (Landing & Archive)

**Purpose**: Secure transfer from on-premises; data **unreadable** until decrypted

**How It Works:**

```
1. FileX generates PGP public/private key pair
2. Public key stored in AWS Secrets Manager
3. On-premises system encrypts file with public key
4. Encrypted file (.gpg) lands in landing bucket
5. Applications CANNOT read this data (encrypted)
6. Lambda retrieves private key from Secrets Manager
7. Lambda decrypts PGP file
8. Lambda applies ALE encryption (if privacy high-risk)
9. Lambda writes to staging bucket
10. Applications CAN NOW read data from staging
```

**Key Characteristics:**

- **Asymmetric encryption** (public/private key pair)
- **File extension**: `.gpg` or `.pgp`
- **Data state**: UNREADABLE in landing bucket
- **Requires decryption**: Before any application access

**Applies To:**

- ALL data coming from on-premises sources
- Data sources: IDP, TSYS (batch), ServiceNow, SailPoint, MECH, XIM, ERE, PEGA, Sybase IQ
- Archive bucket (for reprocessing capability)

-----

### 5.2 ALE (Application-Level Encryption) - Dual KMS

**Purpose**: Maximum security for privacy high-risk data while keeping it readable

**What is ALE:**

- **Application-Level Encryption** using two KMS keys
- **First Layer**: S3 bucket-level KMS encryption (automatic)
- **Second Layer**: Application (Lambda/Glue) encrypts sensitive fields with separate KMS key
- **Result**: Data is encrypted but READABLE by authorized applications

**How It Works:**

```
Two-Layer Encryption:

Layer 1 (S3 Bucket Level):
- Automatic S3 server-side encryption
- Uses KMS CMK: arn:aws:kms:...key/bucket-cmk
- Transparent to applications
- Encrypts entire object

Layer 2 (Application Level):
- Lambda/Glue encrypts specific sensitive fields
- Uses KMS CMK: arn:aws:kms:...key/app-cmk
- Requires explicit decrypt in application
- Encrypts only privacy-sensitive columns
```

**When ALE is Applied:**

- Data classified as **“Privacy High Risk”**
- Examples:
  - Customer PII (names, SSN, addresses)
  - Financial account numbers
  - Credit card details
  - Fraud investigation details
  - User identity information
  - Salary/compensation data

**When ALE is NOT Applied:**

- Standard risk data (metadata, aggregated stats)
- Reference data (lookup tables, codes)
- Non-sensitive operational data

-----

### 5.3 Standard KMS Encryption

**Purpose**: Basic encryption for non-privacy-sensitive data

**How It Works:**

- Single-layer S3 bucket encryption
- Automatic server-side encryption
- Data readable by applications with KMS decrypt permission
- No additional application-level encryption

**Applies To:**

- Data NOT classified as privacy high-risk
- Examples: audit logs, system metadata, aggregated metrics

-----

## 6. Data Flow with Encryption States

### 6.1 On-Premises to Staging (Privacy High-Risk Data)

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: On-Premises System (FileX/SFTP)                    │
│ - File: customer_profiles.parquet                          │
│ - Action: Encrypt with PGP public key                      │
│ - Result: customer_profiles.parquet.gpg                    │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: Landing Bucket                                      │
│ - Location: s3://landing/batch/source=idp/                 │
│ - File: customer_profiles_20240826.parquet.gpg             │
│ - Encryption: PGP encrypted                                 │
│ - State: UNREADABLE by applications                         │
│ - Athena/Glue: CANNOT access this data                     │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: Lambda Decryption Function (Triggered by S3 Event) │
│ - Action: Get PGP private key from Secrets Manager         │
│ - Action: Decrypt .gpg file                                │
│ - Action: Check data classification (Privacy High Risk)    │
│ - Action: Apply ALE encryption (dual KMS)                  │
│   -- Encrypt sensitive fields with app-level KMS           │
│   -- S3 bucket KMS applied automatically                   │
│ - Result: customer_profiles_20240826_staging.parquet       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 4: Staging Bucket                                      │
│ - Location: s3://staging/batch/source=idp/                 │
│ - File: customer_profiles_20240826_staging.parquet         │
│ - Encryption: ALE (dual KMS)                                │
│ - State: READABLE by applications                           │
│ - Athena/Glue: CAN access and query this data              │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 5: Glue ETL Processing                                 │
│ - Action: Read from staging (decrypt both KMS layers)      │
│ - Action: Transform and enrich data                        │
│ - Action: Apply ALE encryption for sensitive fields        │
│ - Result: Curated dataset                                  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 6: Standard Bucket                                     │
│ - Location: s3://standard/customer_analytics/              │
│ - File: customer_profiles_360_20240826_standard.parquet    │
│ - Encryption: ALE (dual KMS)                                │
│ - State: READABLE by analytical tools                       │
│ - BI Tools: CAN access for dashboards and reports          │
└─────────────────────────────────────────────────────────────┘
```

-----

### 6.2 On-Premises to Staging (Standard Risk Data)

```
Step 1: On-Premises → PGP encrypted (.gpg)
Step 2: Landing Bucket → UNREADABLE
Step 3: Lambda → Decrypt PGP, apply standard KMS only (no ALE)
Step 4: Staging Bucket → READABLE, standard KMS encryption
Step 5: Glue ETL → Transform with standard KMS
Step 6: Standard Bucket → Standard KMS encryption
```

**Difference**: No ALE (dual KMS) for standard risk data

-----

### 6.3 Archive for Reprocessing

```
┌─────────────────────────────────────────────────────────────┐
│ Landing Bucket (PGP encrypted file)                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
                    [Copy to Archive]
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Archive Bucket (PGP encrypted backup)                       │
│ - Retention: 1 week to 1 month                              │
│ - Purpose: Emergency reprocessing capability                │
└─────────────────────────────────────────────────────────────┘

If Reprocessing Needed:
┌─────────────────────────────────────────────────────────────┐
│ Archive → Lambda Decryption → Staging (same flow as above) │
└─────────────────────────────────────────────────────────────┘
```

-----

## 7. Lambda Decryption & Encryption Logic

### 7.1 Lambda Function - PGP to ALE Conversion

**Function Name**: `dmine-pgp-to-ale-processor`

**Trigger**: S3 Event Notification when file lands in landing bucket

**Process Flow:**

```python
def lambda_handler(event, context):
    # Step 1: Extract S3 event details
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']
    
    # Step 2: Retrieve PGP private key from Secrets Manager
    private_key = get_secret('pgp-private-key-filex')
    
    # Step 3: Download PGP encrypted file from landing
    encrypted_file = s3.get_object(Bucket=bucket, Key=key)
    
    # Step 4: Decrypt PGP
    decrypted_data = pgp_decrypt(encrypted_file['Body'], private_key)
    
    # Step 5: Check data classification
    dataset_name = extract_dataset_name(key)
    is_privacy_high_risk = check_data_classification(dataset_name)
    
    # Step 6: Apply encryption based on classification
    if is_privacy_high_risk:
        # Apply ALE (dual KMS)
        encrypted_data = apply_ale_encryption(
            decrypted_data,
            app_kms_key='arn:aws:kms:...key/app-cmk',
            sensitive_fields=['customer_id', 'ssn', 'account_number']
        )
    else:
        # Standard KMS only (automatic via S3 bucket encryption)
        encrypted_data = decrypted_data
    
    # Step 7: Write to staging bucket
    staging_key = key.replace('/landing/', '/staging/').replace('.gpg', '_staging.parquet')
    s3.put_object(
        Bucket='bmo-dmine-staging-prod-ca-central',
        Key=staging_key,
        Body=encrypted_data,
        ServerSideEncryption='aws:kms',
        SSEKMSKeyId='arn:aws:kms:...key/bucket-cmk'
    )
    
    # Step 8: Copy to archive bucket (keep PGP encrypted)
    archive_key = key.replace('/landing/', '/archive/')
    s3.copy_object(
        CopySource={'Bucket': bucket, 'Key': key},
        Bucket='bmo-dmine-archive-prod-ca-central',
        Key=archive_key
    )
    
    # Step 9: Delete from landing after successful processing
    # (retention: 1 week to 1 month via lifecycle policy)
    
    # Step 10: Log processing metadata
    log_processing_event(key, staging_key, is_privacy_high_risk, 'SUCCESS')
```

-----

### 7.2 Data Classification Decision Logic

**Privacy High-Risk Datasets:**

```python
PRIVACY_HIGH_RISK_DATASETS = [
    'customer_profiles',
    'user_identities',
    'card_transactions',
    'transaction_alerts',
    'fraud_cases',
    'investigations',
    'case_records',
    'behavior_patterns',
    'access_entitlements',
    'regulatory_reports'
]

def check_data_classification(dataset_name):
    return dataset_name in PRIVACY_HIGH_RISK_DATASETS
```

**Result:**

- **High Risk**: Apply ALE (dual KMS)
- **Standard Risk**: Apply standard KMS only

-----

## 8. Key Management

```
s3://bmo-dmine-landing-prod-ca-central/raw/
├── batch/
│   ├── source=idp/
│   │   ├── dataset=customer_profiles/
│   │   │   └── year=2024/month=08/day=26/
│   │   │       └── idp_customer_profiles_20240826_001_raw.parquet.gpg
│   │   ├── dataset=transaction_history/
│   │   └── dataset=risk_scores/
│   │
│   ├── source=tsys/
│   │   └── dataset=card_transactions/
│   │       └── year=2024/month=08/day=26/
│   │           └── tsys_card_transactions_20240826_raw.csv.gpg
│   │
│   ├── source=mech/
│   ├── source=xim/
│   ├── source=ere/
│   ├── source=pega/
│   ├── source=servicenow/
│   │   ├── dataset=incidents/
│   │   └── dataset=case_records/
│   │
│   ├── source=sailpoint/
│   │   ├── dataset=user_identities/
│   │   └── dataset=access_logs/
│   │
│   └── source=sybaseiq/
│       └── dataset=fraud_cases_historical/
│
├── streaming/
│   ├── source=tsys/
│   │   └── dataset=realtime_transactions/
│   │       └── year=2024/month=08/day=26/hour=14/
│   │           └── tsys_realtime_20240826_140530_raw.json.kms
│   │
│   └── source=kafka/
│       └── dataset=transaction_stream/
│
└── _control/
    ├── manifests/
    ├── checksums/
    └── ingestion_logs/
```

**Encryption at RAW:**

- **Batch Files**: PGP encrypted (.gpg extension) for on-premises sources
- **Streaming Files**: KMS encrypted (no PGP needed)
- **Use Case**: On-premises systems (IBM MQ, SFTP/FileX) transferring data
- **File State**: Encrypted as received, awaiting decryption

-----

### 3.2 CURRENT Folder - KMS Encrypted (Validated)

```
s3://bmo-dmine-landing-prod-ca-central/current/
├── batch/
│   ├── source=idp/
│   │   └── dataset=customer_profiles/
│   │       └── year=2024/month=08/day=26/
│   │           └── idp_customer_profiles_20240826_current.parquet
│   │
│   ├── source=servicenow/
│   │   └── dataset=incidents/
│   │       └── year=2024/month=08/day=26/
│   │           └── servicenow_incidents_20240826_current.parquet
│   │
│   └── source=sailpoint/
│       └── dataset=user_identities/
│           └── year=2024/month=08/day=26/
│               └── sailpoint_users_20240826_current.parquet
│
├── streaming/
│   └── source=tsys/
│       └── dataset=realtime_transactions/
│           └── year=2024/month=08/day=26/hour=14/
│               └── tsys_realtime_20240826_1400_current.parquet
│
└── _quality/
    ├── validation_reports/
    ├── data_profiling/
    └── quality_metrics/
```

**Encryption at CURRENT:**

- **Method**: AWS KMS with Customer Managed Keys (CMKs)
- **Format**: Standardized to Parquet, decrypted from PGP, re-encrypted with KMS
- **State**: Validated, quality-checked, ready for transformation
- **Access**: IAM roles for Glue, Athena, Lambda with KMS decrypt permissions

-----

### 3.3 ARCHIVE Folder - Compressed & Encrypted

```
s3://bmo-dmine-landing-prod-ca-central/archive/
├── batch/
│   ├── source=idp/
│   │   └── dataset=customer_profiles/
│   │       └── year=2024/month=07/
│   │           └── archived_idp_profiles_202407.parquet.gz
│   │
│   └── source=tsys/
│       └── dataset=card_transactions/
│           └── year=2024/month=07/
│               └── archived_tsys_txn_202407.parquet.gz
│
└── _metadata/
    └── archive_manifests/
```

**Encryption at ARCHIVE:**

- **Method**: AWS KMS encryption + Gzip compression
- **Retention**: 90 days before deletion
- **Storage Class**: S3 Glacier Instant Retrieval
- **Purpose**: Compliance backup, reprocessing capability

-----

## 4. Standard Zone Bucket Structure

### 4.1 Domain-Based Organization with Dual KMS

```
s3://bmo-dmine-standard-prod-ca-central/
│
├── fraud_detection/
│   ├── transaction_alerts/
│   │   ├── batch/
│   │   │   └── year=2024/month=08/day=26/
│   │   │       └── fraud_transaction_alerts_20240826_standard.parquet
│   │   ├── streaming/
│   │   │   └── year=2024/month=08/day=26/hour=14/
│   │   │       └── fraud_alerts_realtime_20240826_1400_standard.parquet
│   │   └── consolidated/
│   │
│   ├── fraud_scores/
│   │   ├── daily/
│   │   ├── weekly/
│   │   └── monthly/
│   │
│   └── risk_assessments/
│
├── case_management/
│   ├── investigations/
│   │   ├── active_cases/
│   │   └── closed_cases/
│   │
│   ├── servicenow_incidents/
│   │   ├── open_incidents/
│   │   └── resolved_incidents/
│   │
│   └── evidence_tracking/
│
├── customer_analytics/
│   ├── customer_profiles_360/
│   │   ├── current_profiles/
│   │   ├── profile_history/
│   │   └── profile_snapshots/
│   │
│   ├── behavior_patterns/
│   └── risk_segmentation/
│
├── identity_access/
│   ├── sailpoint_identities/
│   │   ├── active_users/
│   │   └── user_history/
│   │
│   ├── access_entitlements/
│   └── access_logs/
│
├── compliance/
│   ├── audit_trails/
│   ├── regulatory_reports/
│   └── data_lineage/
│
└── _metadata/
    ├── schema_definitions/
    ├── transformation_rules/
    └── quality_standards/
```

-----

## 5. Encryption Strategy Details

### 5.1 Data in Transit Encryption

**Method**: Mutual TLS Encryption

**Implementation:**

- All data transfers use HTTPS with TLS 1.3
- Secure transfer from on-premises to AWS
- Certificate-based authentication
- Encrypted channels for all API communications

**Coverage:**

- On-premises to S3 transfers
- Glue job data movements
- Lambda function invocations
- Athena query results

-----

### 5.2 Data at Rest - S3 Bucket Encryption

**Configuration:**

```
Encryption Algorithm: AES-256
Key Management Service: AWS KMS
Key Type: Customer Managed Keys (CMKs)
Key Rotation: Automatic (Annual)
Deployment: AWS CDK Infrastructure as Code
```

**Bucket-Level Settings:**

- Default encryption enabled on all buckets
- Server-side encryption with KMS CMKs
- Encryption happens automatically on object upload
- No client-side management required

-----

### 5.3 PGP Encryption (On-Premises Transfer)

**Use Case**: For on-premises systems (IBM MQ, SFTP/FileX) transferring data to AWS

**Encryption Method**: PGP (Pretty Good Privacy) - Asymmetric Encryption

#### **Key Management:**

**Public Key:**

- **Location**: AWS Secrets Manager
- **Purpose**: Encryption on FileX/on-premises side
- **Access**: FileX team + AWS Lambda function
- **Distribution**: Provided to FileX team for file encryption

**Private Key:**

- **Location**: AWS Secrets Manager (encrypted copy for Lambda)
- **Original**: Retained by FileX team (on-premises secure storage)
- **Purpose**: Decryption in AWS Lambda
- **Access**: Lambda IAM role with Secrets Manager permissions

#### **Process Flow:**

```
Step 1: FileX generates PGP public/private key pair
    ↓
Step 2: Public key stored in AWS Secrets Manager
    ↓
Step 3: On-premises system encrypts file with public key
    ↓
Step 4: Encrypted file transferred to S3 RAW (file.gpg)
    ↓
Step 5: S3 event triggers Lambda function
    ↓
Step 6: Lambda retrieves private key from Secrets Manager
    ↓
Step 7: Lambda decrypts PGP file
    ↓
Step 8: Lambda re-encrypts with KMS CMK
    ↓
Step 9: Store decrypted+KMS encrypted file in CURRENT folder
    ↓
Step 10: Delete original PGP file from RAW (lifecycle policy)
```

**Landing Zone PGP Processing:**

- Data lands in S3 RAW encrypted with PGP
- Lambda decrypts PGP before moving to curated zone
- Curated zone uses dual KMS encryption (not PGP)

-----

### 5.4 Dual KMS Encryption (KMS on KMS)

**Implementation**: Two layers of KMS encryption for maximum security

#### **First Layer - S3 Bucket Encryption:**

```
Type: Server-Side Encryption
Method: AWS KMS CMK
Application: Automatic at bucket level
Scope: All objects in Standard bucket
Transparency: Transparent to applications
```

#### **Second Layer - Application-Level Encryption:**

```
Type: Client-Side Encryption
Method: Additional KMS CMK via Lambda
Application: Before S3 write operation
Scope: Sensitive fields (PII, fraud scores)
Purpose: Extra security for regulated data
```

#### **Access Control Requirements:**

Services (Glue, Lambda, Athena) must have IAM permissions for:

1. First KMS key (S3 bucket encryption)
1. Second KMS key (application-level encryption)

**Example IAM Policy:**

```json
{
  "Effect": "Allow",
  "Action": [
    "kms:Decrypt",
    "kms:DescribeKey"
  ],
  "Resource": [
    "arn:aws:kms:ca-central-1:account:key/bucket-cmk-id",
    "arn:aws:kms:ca-central-1:account:key/app-cmk-id"
  ]
}
```

#### **Decryption Process:**

```
User/Service reads from Standard bucket
    ↓
S3 automatically decrypts first layer (bucket KMS)
    ↓
Application (Glue) decrypts second layer (app KMS)
    ↓
Data available in plaintext for processing
    ↓
Processing complete
    ↓
Application encrypts with app KMS
    ↓
S3 encrypts with bucket KMS
    ↓
Data stored with dual encryption
```

**When Dual KMS is Applied:**

- Customer PII data
- Fraud investigation records
- Financial transaction details
- Identity and access data
- Any data classified as “Confidential” or “Restricted”

-----

## 6. Encryption by Data Source

### 6.1 Batch Sources (IDP, ServiceNow, SailPoint, MECH, ERE, PEGA)

**Data Flow:**

```
On-Premises Source System
    ↓ (1. File Generation)
FileX/SFTP Transfer Service
    ↓ (2. PGP Encryption with public key)
S3 Landing/RAW
    ↓ (3. File arrives as .gpg encrypted)
Lambda Function Triggered
    ↓ (4. Decrypt PGP with private key from Secrets Manager)
    ↓ (5. Re-encrypt with KMS CMK)
S3 Landing/CURRENT
    ↓ (6. Glue ETL transformation)
S3 Standard Zone (Dual KMS)
```

**Encryption States:**

- **On-Premises → Landing/RAW**: PGP encrypted
- **Landing/CURRENT**: KMS encrypted (single layer)
- **Standard Zone**: Dual KMS encrypted

-----

### 6.2 Streaming Sources (TSYS Real-time, Kafka)

**Data Flow:**

```
Kafka Stream / Real-time Source
    ↓ (1. Streaming data in motion)
Kinesis Data Streams
    ↓ (2. TLS encryption in transit)
Kinesis Firehose / EDF Lambda
    ↓ (3. Apply KMS encryption)
S3 Landing/RAW
    ↓ (4. Already KMS encrypted, no PGP)
S3 Landing/CURRENT
    ↓ (5. Glue streaming job transformation)
S3 Standard Zone (Dual KMS)
```

**Encryption States:**

- **In Transit**: TLS 1.3 encryption
- **Landing/RAW**: KMS encrypted (no PGP needed)
- **Landing/CURRENT**: KMS encrypted
- **Standard Zone**: Dual KMS encrypted

**Note**: Streaming data does NOT use PGP encryption as it’s already in AWS ecosystem via Kinesis

-----

## 7. AWS Glue & Lambda Encryption Logic

### 7.1 Infrastructure Deployment

**Deployment Method**: AWS CDK (Cloud Development Kit)

**Components Deployed:**

```
Infrastructure Components:
├── S3 Buckets (Landing, Standard)
│   └── Encryption: KMS CMK enabled
├── KMS Customer Managed Keys
│   ├── Bucket-level CMK
│   └── Application-level CMK
├── IAM Roles
│   ├── Glue execution role
│   ├── Lambda execution role
│   └── Athena query role
├── Bucket Policies
│   └── Access control definitions
└── Secrets Manager Secrets
    └── PGP private keys
```

-----

### 7.2 Lambda Function - PGP Decryption

**Function Name**: `dmine-pgp-decryption-handler`

**Trigger**: S3 Event Notification on RAW folder file arrival

**Process:**

```python
# Pseudo-code for Lambda PGP decryption
def lambda_handler(event, context):
    # Get file from S3 RAW
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']
    
    # Retrieve PGP private key from Secrets Manager
    private_key = get_secret('filex-pgp-private-key')
    
    # Download encrypted file
    encrypted_file = s3.get_object(Bucket=bucket, Key=key)
    
    # Decrypt using PGP
    decrypted_data = pgp_decrypt(encrypted_file, private_key)
    
    # Re-encrypt with KMS (automatic via S3 bucket encryption)
    target_key = key.replace('/raw/', '/current/').replace('.gpg', '')
    
    # Upload to CURRENT folder
    s3.put_object(
        Bucket=bucket,
        Key=target_key,
        Body=decrypted_data,
        ServerSideEncryption='aws:kms',
        SSEKMSKeyId='arn:aws:kms:...:key/bucket-cmk'
    )
    
    # Log processing
    log_processing_metadata(key, target_key, 'SUCCESS')
```

-----

### 7.3 Lambda Function - Dual KMS Encryption

**Function Name**: `dmine-dual-kms-encryption-handler`

**Purpose**: Apply application-level encryption before writing to Standard zone

**Process:**

```python
# Pseudo-code for dual KMS encryption
def lambda_handler(event, context):
    # Read from Landing/CURRENT
    data = glue_context.read_parquet(landing_current_path)
    
    # Identify sensitive fields
    sensitive_fields = ['customer_id', 'ssn', 'fraud_score', 'account_number']
    
    # Encrypt sensitive fields with application KMS key
    for field in sensitive_fields:
        if field in data.columns:
            data[field] = kms_encrypt(
                data[field],
                key_id='arn:aws:kms:...:key/app-cmk'
            )
    
    # Write to Standard zone
    # S3 bucket encryption (first layer) applied automatically
    data.write.parquet(
        standard_zone_path,
        mode='overwrite',
        partitionBy=['year', 'month', 'day']
    )
```

-----

### 7.4 Glue ETL Scripts - Encryption Handling

**Glue Job**: `transform-landing-to-standard`

**Encryption Logic:**

```python
# Glue script determines when to apply application-level encryption
def apply_encryption_logic(data, dataset_name):
    # Business rules determine encryption requirements
    if dataset_name in ['customer_profiles', 'fraud_cases', 'pii_data']:
        # Apply dual KMS
        return encrypt_with_dual_kms(data)
    else:
        # Standard KMS only (bucket-level)
        return data
```

**Access Control:**

```
Glue IAM Role requires:
- kms:Decrypt for bucket CMK (read from Landing)
- kms:Encrypt for bucket CMK (write to Standard)
- kms:Decrypt for app CMK (read sensitive data)
- kms:Encrypt for app CMK (write sensitive data)
```

-----

## 8. EDF (Event-Driven Framework) Integration

### 8.1 Kafka to S3 with KMS Encryption

**Architecture:**

```
On-Premises Kafka Topic
    ↓
AWS Kinesis Data Streams (bridge)
    ↓
EDF Lambda Function (consumer)
    ↓
Lambda processes event
    ↓
Lambda encrypts with KMS
    ↓
Writes to S3 Landing/RAW
```

**EDF Lambda Pattern:**

- One Lambda handles multiple Kafka topics
- Concurrent runners for parallel processing
- Built-in retry and error handling
- KMS encryption before S3 write

**Encryption:**

- No PGP for streaming data (already in AWS)
- KMS encryption applied by Lambda before S3 write
- Dual KMS when writing to Standard zone

-----

## 9. Logs and Metadata Encryption

### 9.1 Control Files and Processing Logs

**Requirement**: Logs must be encrypted to avoid sensitive data exposure

**Implementation:**

**Glue Job Logs:**

```
Location: CloudWatch Logs
Encryption: CloudWatch log group encrypted with KMS
Retention: 90 days
```

**Application Logs in S3:**

```
s3://bmo-dmine-landing-prod-ca-central/_control/processing_logs/
└── glue_execution_logs_20240826.json.encrypted

Encryption: Preferably PGP or KMS
Purpose: Avoid exposing sensitive data in logs
```

**Metadata Files:**

```
s3://bmo-dmine-standard-prod-ca-central/_metadata/
├── schema_definitions/
├── transformation_rules/
└── data_lineage/

Encryption: Dual KMS (contains sensitive metadata)
```

-----

## 10. File Naming Conventions with Encryption

### 10.1 Landing/RAW (PGP Encrypted)

**Batch Files:**

```
Format: {source}_{dataset}_{yyyymmdd}_{sequence}_raw.{format}.gpg

Examples:
idp_customer_profiles_20240826_001_raw.parquet.gpg
tsys_card_transactions_20240826_001_raw.csv.gpg
servicenow_incidents_20240826_001_raw.json.gpg
```

**Streaming Files:**

```
Format: {source}_{dataset}_{yyyymmdd}_{hhmmss}_raw.{format}.kms

Examples:
tsys_realtime_20240826_140530_raw.json (KMS encrypted, not PGP)
kafka_transactions_20240826_140532_raw.json
```

-----

### 10.2 Landing/CURRENT (KMS Encrypted)

**Format:** `{source}_{dataset}_{yyyymmdd}_current.parquet`

**Examples:**

```
idp_customer_profiles_20240826_current.parquet
tsys_card_transactions_20240826_current.parquet
servicenow_incidents_20240826_current.parquet
sailpoint_users_20240826_current.parquet
```

**Note**: No .gpg extension - PGP decrypted, KMS encrypted

-----

### 10.3 Standard Zone (Dual KMS Encrypted)

**Format:** `{domain}_{dataset}_{yyyymmdd}_standard.parquet`

**Examples:**

```
fraud_transaction_alerts_20240826_standard.parquet
case_management_investigations_20240826_standard.parquet
customer_profiles_360_20240826_standard.parquet
identity_sailpoint_users_20240826_standard.parquet
```

**Note**: Dual KMS encryption applied, transparent to filename

-----

## 11. Encryption Summary by Zone

|**Zone**    |**Folder**     |**Encryption Method**|**Key Management**                 |**File Extension**|
|------------|---------------|---------------------|-----------------------------------|------------------|
|**Landing** |RAW (Batch)    |PGP                  |Public: AWS Secrets, Private: FileX|.gpg              |
|**Landing** |RAW (Streaming)|KMS CMK              |AWS KMS                            |.kms or none      |
|**Landing** |CURRENT        |KMS CMK (single)     |AWS KMS                            |.parquet          |
|**Landing** |ARCHIVE        |KMS CMK + Gzip       |AWS KMS                            |.gz               |
|**Standard**|All Folders    |Dual KMS             |AWS KMS (2 keys)                   |.parquet          |

-----

## 12. Key Action Items & Implementation Plan

### 12.1 Immediate Actions

- ✅ **Confirm PGP onboarding with FileX team**
  - Coordinate public/private key pair generation
  - Store public key in AWS Secrets Manager
  - Provide public key to FileX for encryption setup
- ✅ **Deploy AWS infrastructure via CDK**
  - Create S3 buckets with encryption enabled
  - Generate KMS Customer Managed Keys
  - Configure IAM roles and policies
  - Set up Secrets Manager for PGP keys
- ✅ **Ensure dual KMS encryption for Standard bucket**
  - Configure bucket-level KMS
  - Develop Lambda for application-level KMS
  - Test dual encryption/decryption flow
- ✅ **Update architecture diagrams**
  - Document multiple buckets (Landing, Standard, Archive)
  - Show encryption layers (PGP → KMS → Dual KMS)
  - Include data flow with encryption states
- ✅ **Request EDF Lambda code for Kafka integration**
  - Obtain EDF pattern implementation
  - Customize for DMINE Kafka topics
  - Test with sample data streams

-----

### 12.2 Testing & Validation

**Encryption Testing:**

1. Test PGP encryption/decryption with sample files
1. Validate KMS encryption at rest
1. Verify dual KMS encryption for sensitive data
1. Test Lambda decryption functions
1. Validate Glue access to encrypted data

**Security Validation:**

1. Verify IAM permissions for KMS keys
1. Test key rotation procedures
1. Validate Secrets Manager access controls
1. Review CloudTrail logs for encryption events
1. Conduct penetration testing on encrypted data access

-----

## 13. Security Best Practices

### 13.1 Key Management

- **Principle of Least Privilege**: IAM roles grant minimum required KMS permissions
- **Key Rotation**: Annual automatic rotation enabled for all CMKs
- **Key Backup**: KMS keys backed up in multi-region configuration
- **Access Auditing**: CloudTrail logs all KMS key usage
- **Separation of Duties**: Different keys for different security domains

### 13.2 Encryption Governance

- **Encryption Standards**: AES-256 for all data at rest
- **TLS Standards**: TLS 1.3 minimum for data in transit
- **PGP Standards**: RSA 4096-bit keys for on-premises transfer
- **Key Length**: Minimum 256-bit symmetric, 4096-bit asymmetric
- **Algorithm Approval**: Only FIPS 140-2 approved algorithms

### 13.3 Monitoring & Compliance

- **CloudTrail Logging**: All S3 and KMS operations logged
- **CloudWatch Alerts**: Encryption failure notifications
- **Compliance Validation**: Quarterly encryption audits
- **Access Reviews**: Monthly review of KMS key policies
- **Incident Response**: Documented procedures for key compromise

-----

## 14. Appendix

### 14.1 Glossary

- **PGP**: Pretty Good Privacy - Asymmetric encryption for file transfer
- **KMS**: Key Management Service - AWS managed encryption service
- **CMK**: Customer Managed Key - User-controlled encryption keys in KMS
- **Dual KMS**: Two-layer KMS encryption (bucket + application level)
- **TLS**: Transport Layer Security - Encryption for data in transit
- **EDF**: Event-Driven Framework - Pattern for Kafka integration

### 14.2 Reference Documents

- AWS KMS Best Practices: https://docs.aws.amazon.com/kms/
- S3 Encryption Documentation: https://docs.aws.amazon.com/s3/encryption/
- BMO Data Classification Policy: [Internal Reference]
- DMINE Phase 1 Architecture: [Project Documentation]

### 14.3 Contact Information

- **Security Team**: security@bmo.com
- **Cloud Engineering**: cloud-eng@bmo.com
- **FileX Team**: filex-support@bmo.com
- **DMINE Project Lead**: [Project Manager Contact]

-----

**Document Control:**

- Version: 1.0
- Classification: Internal - BMO Confidential
- Next Review: Quarterly
- Owner: DMINE Project Team / Enterprise Architecture





Bucket Name: s3://bmo-dmine-landing-prod-ca-central/
Region: ca-central-1 (Canada Central)
```

**Purpose**: Initial data ingestion, validation, and temporary processing  
**Encryption**: PGP for incoming files, KMS for processed data  
**Retention**: Short-term (7-90 days with lifecycle policies)  
**Data State**: Raw and validated data

#### **Bucket 2: Standard Zone (Silver Layer)**

```
Bucket Name: s3://bmo-dmine-standard-prod-ca-central/
Region: ca-central-1 (Canada Central)
```

**Purpose**: Curated, analytics-ready, business-aligned datasets  
**Encryption**: Dual KMS encryption (KMS on KMS)  
**Retention**: Long-term (7+ years for regulatory compliance)  
**Data State**: Transformed, enriched, domain-organized

-----

## 3. Landing Zone Bucket Structure

### 3.1 RAW Folder - PGP Encrypted Files

```
s3://bmo-dmine-landing-prod-ca-central/raw/
├── batch/
│   ├── source=idp/
│   │   ├── dataset=customer_profiles/
│   │   │   └── year=2024/month=08/day=26/
│   │   │       └── idp_customer_profiles_20240826_001_raw.parquet.gpg
│   │   ├── dataset=transaction_history/
│   │   └── dataset=risk_scores/
│   │
│   ├── source=tsys/
│   │   └── dataset=card_transactions/
│   │       └── year=2024/month=08/day=26/
│   │           └── tsys_card_transactions_20240826_raw.csv.gpg
│   │
│   ├── source=mech/
│   ├── source=xim/
│   ├── source=ere/
│   ├── source=pega/
│   ├── source=servicenow/
│   │   ├── dataset=incidents/
│   │   └── dataset=case_records/
│   │
│   ├── source=sailpoint/
│   │   ├── dataset=user_identities/
│   │   └── dataset=access_logs/
│   │
│   └── source=sybaseiq/
│       └── dataset=fraud_cases_historical/
│
├── streaming/
│   ├── source=tsys/
│   │   └── dataset=realtime_transactions/
│   │       └── year=2024/month=08/day=26/hour=14/
│   │           └── tsys_realtime_20240826_140530_raw.json.kms
│   │
│   └── source=kafka/
│       └── dataset=transaction_stream/
│
└── _control/
    ├── manifests/
    ├── checksums/
    └── ingestion_logs/
```

**Encryption at RAW:**

- **Batch Files**: PGP encrypted (.gpg extension) for on-premises sources
- **Streaming Files**: KMS encrypted (no PGP needed)
- **Use Case**: On-premises systems (IBM MQ, SFTP/FileX) transferring data
- **File State**: Encrypted as received, awaiting decryption

-----

### 3.2 CURRENT Folder - KMS Encrypted (Validated)

```
s3://bmo-dmine-landing-prod-ca-central/current/
├── batch/
│   ├── source=idp/
│   │   └── dataset=customer_profiles/
│   │       └── year=2024/month=08/day=26/
│   │           └── idp_customer_profiles_20240826_current.parquet
│   │
│   ├── source=servicenow/
│   │   └── dataset=incidents/
│   │       └── year=2024/month=08/day=26/
│   │           └── servicenow_incidents_20240826_current.parquet
│   │
│   └── source=sailpoint/
│       └── dataset=user_identities/
│           └── year=2024/month=08/day=26/
│               └── sailpoint_users_20240826_current.parquet
│
├── streaming/
│   └── source=tsys/
│       └── dataset=realtime_transactions/
│           └── year=2024/month=08/day=26/hour=14/
│               └── tsys_realtime_20240826_1400_current.parquet
│
└── _quality/
    ├── validation_reports/
    ├── data_profiling/
    └── quality_metrics/
```

**Encryption at CURRENT:**

- **Method**: AWS KMS with Customer Managed Keys (CMKs)
- **Format**: Standardized to Parquet, decrypted from PGP, re-encrypted with KMS
- **State**: Validated, quality-checked, ready for transformation
- **Access**: IAM roles for Glue, Athena, Lambda with KMS decrypt permissions

-----

### 3.3 ARCHIVE Folder - Compressed & Encrypted

```
s3://bmo-dmine-landing-prod-ca-central/archive/
├── batch/
│   ├── source=idp/
│   │   └── dataset=customer_profiles/
│   │       └── year=2024/month=07/
│   │           └── archived_idp_profiles_202407.parquet.gz
│   │
│   └── source=tsys/
│       └── dataset=card_transactions/
│           └── year=2024/month=07/
│               └── archived_tsys_txn_202407.parquet.gz
│
└── _metadata/
    └── archive_manifests/
```

**Encryption at ARCHIVE:**

- **Method**: AWS KMS encryption + Gzip compression
- **Retention**: 90 days before deletion
- **Storage Class**: S3 Glacier Instant Retrieval
- **Purpose**: Compliance backup, reprocessing capability

-----

## 4. Standard Zone Bucket Structure

### 4.1 Domain-Based Organization with Dual KMS

```
s3://bmo-dmine-standard-prod-ca-central/
│
├── fraud_detection/
│   ├── transaction_alerts/
│   │   ├── batch/
│   │   │   └── year=2024/month=08/day=26/
│   │   │       └── fraud_transaction_alerts_20240826_standard.parquet
│   │   ├── streaming/
│   │   │   └── year=2024/month=08/day=26/hour=14/
│   │   │       └── fraud_alerts_realtime_20240826_1400_standard.parquet
│   │   └── consolidated/
│   │
│   ├── fraud_scores/
│   │   ├── daily/
│   │   ├── weekly/
│   │   └── monthly/
│   │
│   └── risk_assessments/
│
├── case_management/
│   ├── investigations/
│   │   ├── active_cases/
│   │   └── closed_cases/
│   │
│   ├── servicenow_incidents/
│   │   ├── open_incidents/
│   │   └── resolved_incidents/
│   │
│   └── evidence_tracking/
│
├── customer_analytics/
│   ├── customer_profiles_360/
│   │   ├── current_profiles/
│   │   ├── profile_history/
│   │   └── profile_snapshots/
│   │
│   ├── behavior_patterns/
│   └── risk_segmentation/
│
├── identity_access/
│   ├── sailpoint_identities/
│   │   ├── active_users/
│   │   └── user_history/
│   │
│   ├── access_entitlements/
│   └── access_logs/
│
├── compliance/
│   ├── audit_trails/
│   ├── regulatory_reports/
│   └── data_lineage/
│
└── _metadata/
    ├── schema_definitions/
    ├── transformation_rules/
    └── quality_standards/
```

-----

## 5. Encryption Strategy Details

### 5.1 Data in Transit Encryption

**Method**: Mutual TLS Encryption

**Implementation:**

- All data transfers use HTTPS with TLS 1.3
- Secure transfer from on-premises to AWS
- Certificate-based authentication
- Encrypted channels for all API communications

**Coverage:**

- On-premises to S3 transfers
- Glue job data movements
- Lambda function invocations
- Athena query results

-----

### 5.2 Data at Rest - S3 Bucket Encryption

**Configuration:**

```
Encryption Algorithm: AES-256
Key Management Service: AWS KMS
Key Type: Customer Managed Keys (CMKs)
Key Rotation: Automatic (Annual)
Deployment: AWS CDK Infrastructure as Code
```

**Bucket-Level Settings:**

- Default encryption enabled on all buckets
- Server-side encryption with KMS CMKs
- Encryption happens automatically on object upload
- No client-side management required

-----

### 5.3 PGP Encryption (On-Premises Transfer)

**Use Case**: For on-premises systems (IBM MQ, SFTP/FileX) transferring data to AWS

**Encryption Method**: PGP (Pretty Good Privacy) - Asymmetric Encryption

#### **Key Management:**

**Public Key:**

- **Location**: AWS Secrets Manager
- **Purpose**: Encryption on FileX/on-premises side
- **Access**: FileX team + AWS Lambda function
- **Distribution**: Provided to FileX team for file encryption

**Private Key:**

- **Location**: AWS Secrets Manager (encrypted copy for Lambda)
- **Original**: Retained by FileX team (on-premises secure storage)
- **Purpose**: Decryption in AWS Lambda
- **Access**: Lambda IAM role with Secrets Manager permissions

#### **Process Flow:**

```
Step 1: FileX generates PGP public/private key pair
    ↓
Step 2: Public key stored in AWS Secrets Manager
    ↓
Step 3: On-premises system encrypts file with public key
    ↓
Step 4: Encrypted file transferred to S3 RAW (file.gpg)
    ↓
Step 5: S3 event triggers Lambda function
    ↓
Step 6: Lambda retrieves private key from Secrets Manager
    ↓
Step 7: Lambda decrypts PGP file
    ↓
Step 8: Lambda re-encrypts with KMS CMK
    ↓
Step 9: Store decrypted+KMS encrypted file in CURRENT folder
    ↓
Step 10: Delete original PGP file from RAW (lifecycle policy)
```

**Landing Zone PGP Processing:**

- Data lands in S3 RAW encrypted with PGP
- Lambda decrypts PGP before moving to curated zone
- Curated zone uses dual KMS encryption (not PGP)

-----

### 5.4 Dual KMS Encryption (KMS on KMS)

**Implementation**: Two layers of KMS encryption for maximum security

#### **First Layer - S3 Bucket Encryption:**

```
Type: Server-Side Encryption
Method: AWS KMS CMK
Application: Automatic at bucket level
Scope: All objects in Standard bucket
Transparency: Transparent to applications
```

#### **Second Layer - Application-Level Encryption:**

```
Type: Client-Side Encryption
Method: Additional KMS CMK via Lambda
Application: Before S3 write operation
Scope: Sensitive fields (PII, fraud scores)
Purpose: Extra security for regulated data
```

#### **Access Control Requirements:**

Services (Glue, Lambda, Athena) must have IAM permissions for:

1. First KMS key (S3 bucket encryption)
1. Second KMS key (application-level encryption)

**Example IAM Policy:**

```json
{
  "Effect": "Allow",
  "Action": [
    "kms:Decrypt",
    "kms:DescribeKey"
  ],
  "Resource": [
    "arn:aws:kms:ca-central-1:account:key/bucket-cmk-id",
    "arn:aws:kms:ca-central-1:account:key/app-cmk-id"
  ]
}
```

#### **Decryption Process:**

```
User/Service reads from Standard bucket
    ↓
S3 automatically decrypts first layer (bucket KMS)
    ↓
Application (Glue) decrypts second layer (app KMS)
    ↓
Data available in plaintext for processing
    ↓
Processing complete
    ↓
Application encrypts with app KMS
    ↓
S3 encrypts with bucket KMS
    ↓
Data stored with dual encryption
```

**When Dual KMS is Applied:**

- Customer PII data
- Fraud investigation records
- Financial transaction details
- Identity and access data
- Any data classified as “Confidential” or “Restricted”

-----

## 6. Encryption by Data Source

### 6.1 Batch Sources (IDP, ServiceNow, SailPoint, MECH, ERE, PEGA)

**Data Flow:**

```
On-Premises Source System
    ↓ (1. File Generation)
FileX/SFTP Transfer Service
    ↓ (2. PGP Encryption with public key)
S3 Landing/RAW
    ↓ (3. File arrives as .gpg encrypted)
Lambda Function Triggered
    ↓ (4. Decrypt PGP with private key from Secrets Manager)
    ↓ (5. Re-encrypt with KMS CMK)
S3 Landing/CURRENT
    ↓ (6. Glue ETL transformation)
S3 Standard Zone (Dual KMS)
```

**Encryption States:**

- **On-Premises → Landing/RAW**: PGP encrypted
- **Landing/CURRENT**: KMS encrypted (single layer)
- **Standard Zone**: Dual KMS encrypted

-----

### 6.2 Streaming Sources (TSYS Real-time, Kafka)

**Data Flow:**

```
Kafka Stream / Real-time Source
    ↓ (1. Streaming data in motion)
Kinesis Data Streams
    ↓ (2. TLS encryption in transit)
Kinesis Firehose / EDF Lambda
    ↓ (3. Apply KMS encryption)
S3 Landing/RAW
    ↓ (4. Already KMS encrypted, no PGP)
S3 Landing/CURRENT
    ↓ (5. Glue streaming job transformation)
S3 Standard Zone (Dual KMS)
```

**Encryption States:**

- **In Transit**: TLS 1.3 encryption
- **Landing/RAW**: KMS encrypted (no PGP needed)
- **Landing/CURRENT**: KMS encrypted
- **Standard Zone**: Dual KMS encrypted

**Note**: Streaming data does NOT use PGP encryption as it’s already in AWS ecosystem via Kinesis

-----

## 7. AWS Glue & Lambda Encryption Logic

### 7.1 Infrastructure Deployment

**Deployment Method**: AWS CDK (Cloud Development Kit)

**Components Deployed:**

```
Infrastructure Components:
├── S3 Buckets (Landing, Standard)
│   └── Encryption: KMS CMK enabled
├── KMS Customer Managed Keys
│   ├── Bucket-level CMK
│   └── Application-level CMK
├── IAM Roles
│   ├── Glue execution role
│   ├── Lambda execution role
│   └── Athena query role
├── Bucket Policies
│   └── Access control definitions
└── Secrets Manager Secrets
    └── PGP private keys
```

-----

### 7.2 Lambda Function - PGP Decryption

**Function Name**: `dmine-pgp-decryption-handler`

**Trigger**: S3 Event Notification on RAW folder file arrival

**Process:**

```python
# Pseudo-code for Lambda PGP decryption
def lambda_handler(event, context):
    # Get file from S3 RAW
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']
    
    # Retrieve PGP private key from Secrets Manager
    private_key = get_secret('filex-pgp-private-key')
    
    # Download encrypted file
    encrypted_file = s3.get_object(Bucket=bucket, Key=key)
    
    # Decrypt using PGP
    decrypted_data = pgp_decrypt(encrypted_file, private_key)
    
    # Re-encrypt with KMS (automatic via S3 bucket encryption)
    target_key = key.replace('/raw/', '/current/').replace('.gpg', '')
    
    # Upload to CURRENT folder
    s3.put_object(
        Bucket=bucket,
        Key=target_key,
        Body=decrypted_data,
        ServerSideEncryption='aws:kms',
        SSEKMSKeyId='arn:aws:kms:...:key/bucket-cmk'
    )
    
    # Log processing
    log_processing_metadata(key, target_key, 'SUCCESS')
```

-----

### 7.3 Lambda Function - Dual KMS Encryption

**Function Name**: `dmine-dual-kms-encryption-handler`

**Purpose**: Apply application-level encryption before writing to Standard zone

**Process:**

```python
# Pseudo-code for dual KMS encryption
def lambda_handler(event, context):
    # Read from Landing/CURRENT
    data = glue_context.read_parquet(landing_current_path)
    
    # Identify sensitive fields
    sensitive_fields = ['customer_id', 'ssn', 'fraud_score', 'account_number']
    
    # Encrypt sensitive fields with application KMS key
    for field in sensitive_fields:
        if field in data.columns:
            data[field] = kms_encrypt(
                data[field],
                key_id='arn:aws:kms:...:key/app-cmk'
            )
    
    # Write to Standard zone
    # S3 bucket encryption (first layer) applied automatically
    data.write.parquet(
        standard_zone_path,
        mode='overwrite',
        partitionBy=['year', 'month', 'day']
    )
```

-----

### 7.4 Glue ETL Scripts - Encryption Handling

**Glue Job**: `transform-landing-to-standard`

**Encryption Logic:**

```python
# Glue script determines when to apply application-level encryption
def apply_encryption_logic(data, dataset_name):
    # Business rules determine encryption requirements
    if dataset_name in ['customer_profiles', 'fraud_cases', 'pii_data']:
        # Apply dual KMS
        return encrypt_with_dual_kms(data)
    else:
        # Standard KMS only (bucket-level)
        return data
```

**Access Control:**

```
Glue IAM Role requires:
- kms:Decrypt for bucket CMK (read from Landing)
- kms:Encrypt for bucket CMK (write to Standard)
- kms:Decrypt for app CMK (read sensitive data)
- kms:Encrypt for app CMK (write sensitive data)
```

-----

## 8. EDF (Event-Driven Framework) Integration

### 8.1 Kafka to S3 with KMS Encryption

**Architecture:**

```
On-Premises Kafka Topic
    ↓
AWS Kinesis Data Streams (bridge)
    ↓
EDF Lambda Function (consumer)
    ↓
Lambda processes event
    ↓
Lambda encrypts with KMS
    ↓
Writes to S3 Landing/RAW
```

**EDF Lambda Pattern:**

- One Lambda handles multiple Kafka topics
- Concurrent runners for parallel processing
- Built-in retry and error handling
- KMS encryption before S3 write

**Encryption:**

- No PGP for streaming data (already in AWS)
- KMS encryption applied by Lambda before S3 write
- Dual KMS when writing to Standard zone

-----

## 9. Logs and Metadata Encryption

### 9.1 Control Files and Processing Logs

**Requirement**: Logs must be encrypted to avoid sensitive data exposure

**Implementation:**

**Glue Job Logs:**

```
Location: CloudWatch Logs
Encryption: CloudWatch log group encrypted with KMS
Retention: 90 days
```

**Application Logs in S3:**

```
s3://bmo-dmine-landing-prod-ca-central/_control/processing_logs/
└── glue_execution_logs_20240826.json.encrypted

Encryption: Preferably PGP or KMS
Purpose: Avoid exposing sensitive data in logs
```

**Metadata Files:**

```
s3://bmo-dmine-standard-prod-ca-central/_metadata/
├── schema_definitions/
├── transformation_rules/
└── data_lineage/

Encryption: Dual KMS (contains sensitive metadata)
```

-----

## 10. File Naming Conventions with Encryption

### 10.1 Landing/RAW (PGP Encrypted)

**Batch Files:**

```
Format: {source}_{dataset}_{yyyymmdd}_{sequence}_raw.{format}.gpg

Examples:
idp_customer_profiles_20240826_001_raw.parquet.gpg
tsys_card_transactions_20240826_001_raw.csv.gpg
servicenow_incidents_20240826_001_raw.json.gpg
```

**Streaming Files:**

```
Format: {source}_{dataset}_{yyyymmdd}_{hhmmss}_raw.{format}.kms

Examples:
tsys_realtime_20240826_140530_raw.json (KMS encrypted, not PGP)
kafka_transactions_20240826_140532_raw.json
```

-----

### 10.2 Landing/CURRENT (KMS Encrypted)

**Format:** `{source}_{dataset}_{yyyymmdd}_current.parquet`

**Examples:**

```
idp_customer_profiles_20240826_current.parquet
tsys_card_transactions_20240826_current.parquet
servicenow_incidents_20240826_current.parquet
sailpoint_users_20240826_current.parquet
```

**Note**: No .gpg extension - PGP decrypted, KMS encrypted

-----

### 10.3 Standard Zone (Dual KMS Encrypted)

**Format:** `{domain}_{dataset}_{yyyymmdd}_standard.parquet`

**Examples:**

```
fraud_transaction_alerts_20240826_standard.parquet
case_management_investigations_20240826_standard.parquet
customer_profiles_360_20240826_standard.parquet
identity_sailpoint_users_20240826_standard.parquet
```

**Note**: Dual KMS encryption applied, transparent to filename

-----

## 11. Encryption Summary by Zone

|**Zone**    |**Folder**     |**Encryption Method**|**Key Management**                 |**File Extension**|
|------------|---------------|---------------------|-----------------------------------|------------------|
|**Landing** |RAW (Batch)    |PGP                  |Public: AWS Secrets, Private: FileX|.gpg              |
|**Landing** |RAW (Streaming)|KMS CMK              |AWS KMS                            |.kms or none      |
|**Landing** |CURRENT        |KMS CMK (single)     |AWS KMS                            |.parquet          |
|**Landing** |ARCHIVE        |KMS CMK + Gzip       |AWS KMS                            |.gz               |
|**Standard**|All Folders    |Dual KMS             |AWS KMS (2 keys)                   |.parquet          |

-----

## 12. Key Action Items & Implementation Plan

### 12.1 Immediate Actions

- ✅ **Confirm PGP onboarding with FileX team**
  - Coordinate public/private key pair generation
  - Store public key in AWS Secrets Manager
  - Provide public key to FileX for encryption setup
- ✅ **Deploy AWS infrastructure via CDK**
  - Create S3 buckets with encryption enabled
  - Generate KMS Customer Managed Keys
  - Configure IAM roles and policies
  - Set up Secrets Manager for PGP keys
- ✅ **Ensure dual KMS encryption for Standard bucket**
  - Configure bucket-level KMS
  - Develop Lambda for application-level KMS
  - Test dual encryption/decryption flow
- ✅ **Update architecture diagrams**
  - Document multiple buckets (Landing, Standard, Archive)
  - Show encryption layers (PGP → KMS → Dual KMS)
  - Include data flow with encryption states
- ✅ **Request EDF Lambda code for Kafka integration**
  - Obtain EDF pattern implementation
  - Customize for DMINE Kafka topics
  - Test with sample data streams

-----

### 12.2 Testing & Validation

**Encryption Testing:**

1. Test PGP encryption/decryption with sample files
1. Validate KMS encryption at rest
1. Verify dual KMS encryption for sensitive data
1. Test Lambda decryption functions
1. Validate Glue access to encrypted data

**Security Validation:**

1. Verify IAM permissions for KMS keys
1. Test key rotation procedures
1. Validate Secrets Manager access controls
1. Review CloudTrail logs for encryption events
1. Conduct penetration testing on encrypted data access

-----

## 13. Security Best Practices

### 13.1 Key Management

- **Principle of Least Privilege**: IAM roles grant minimum required KMS permissions
- **Key Rotation**: Annual automatic rotation enabled for all CMKs
- **Key Backup**: KMS keys backed up in multi-region configuration
- **Access Auditing**: CloudTrail logs all KMS key usage
- **Separation of Duties**: Different keys for different security domains

### 13.2 Encryption Governance

- **Encryption Standards**: AES-256 for all data at rest
- **TLS Standards**: TLS 1.3 minimum for data in transit
- **PGP Standards**: RSA 4096-bit keys for on-premises transfer
- **Key Length**: Minimum 256-bit symmetric, 4096-bit asymmetric
- **Algorithm Approval**: Only FIPS 140-2 approved algorithms

### 13.3 Monitoring & Compliance

- **CloudTrail Logging**: All S3 and KMS operations logged
- **CloudWatch Alerts**: Encryption failure notifications
- **Compliance Validation**: Quarterly encryption audits
- **Access Reviews**: Monthly review of KMS key policies
- **Incident Response**: Documented procedures for key compromise

-----

## 14. Appendix

### 14.1 Glossary

- **PGP**: Pretty Good Privacy - Asymmetric encryption for file transfer
- **KMS**: Key Management Service - AWS managed encryption service
- **CMK**: Customer Managed Key - User-controlled encryption keys in KMS
- **Dual KMS**: Two-layer KMS encryption (bucket + application level)
- **TLS**: Transport Layer Security - Encryption for data in transit
- **EDF**: Event-Driven Framework - Pattern for Kafka integration

### 14.2 Reference Documents

- AWS KMS Best Practices: https://docs.aws.amazon.com/kms/
- S3 Encryption Documentation: https://docs.aws.amazon.com/s3/encryption/
- BMO Data Classification Policy: [Internal Reference]
- DMINE Phase 1 Architecture: [Project Documentation]

### 14.3 Contact Information

- **Security Team**: security@bmo.com
- **Cloud Engineering**: cloud-eng@bmo.com
- **FileX Team**: filex-support@bmo.com
- **DMINE Project Lead**: [Project Manager Contact]

-----

**Document Control:**

- Version: 1.0
- Classification: Internal - BMO Confidential
- Next Review: Quarterly
- Owner: DMINE Project Team / Enterprise Architecture